<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SCiPNET - Records Archive</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>DATABASE_QUERY: SECURE_ARCHIVES</h1>
    <nav>
        <a href="dashboard.html">RETURN_TO_DASHBOARD</a>
        <div id="overseer-filters" style="display:none; margin-top:10px; border:1px solid gold; padding:5px;">
            <span style="color:gold">OVERSEER_VIEW:</span>
            <select id="dept-filter" onchange="fetchReports()">
                <option value="ALL">ALL_DEPARTMENTS</option>
                <option value="ScD">SCIENTIFIC (ScD)</option>
                <option value="MD">MEDICAL (MD)</option>
                <option value="RAISA">INFOSEC (RAISA)</option>
            </select>
        </div>
    </nav>

    <table id="archive-table">
        <thead>
            <tr>
                <th>DATE</th>
                <th>DEPT</th>
                <th>CLEARANCE</th>
                <th>DOCUMENT_TITLE</th>
                <th>AUTHOR</th>
                <th>ACTION</th>
            </tr>
        </thead>
        <tbody id="report-list">
            </tbody>
    </table>

    <script>
        let isOverseer = false;

        async function initArchive() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) { window.location.href = "index.html"; return; }

            const { data: profile } = await _supabase.from('profiles').select('*').eq('id', user.id).single();
            
            if (profile.is_overseer) {
                isOverseer = true;
                document.getElementById('overseer-filters').style.display = 'block';
            }
            
            fetchReports();
        }

        async function fetchReports() {
            const list = document.getElementById('report-list');
            list.innerHTML = "<tr><td colspan='6'>RETRIEVING_DATA...</td></tr>";

            // 1. Get current user profile data
            const { data: { user } } = await _supabase.auth.getUser();
            const { data: profile } = await _supabase.from('profiles').select('department, clearance_level').eq('id', user.id).single();

            // 2. Start the query
            let query = _supabase.from('reports').select('*').order('created_at', { ascending: false });

            // 3. APPLY CLIENT-SIDE FILTERS (To match RLS)
            if (!isOverseer) {
                // Normal users only see their department and their clearance or lower
                query = query.eq('dept_code', profile.department)
                            .lte('clearance_level', profile.clearance_level);
            } else {
                // Overseer filters (the dropdown)
                const filter = document.getElementById('dept-filter').value;
                if (filter !== "ALL") {
                    query = query.eq('dept_code', filter);
                }
            }

            const { data: reports, error } = await query;

            if (error) {
                list.innerHTML = `<tr><td colspan='6' style='color:red'>QUERY_ERROR: ${error.message}</td></tr>`;
                return;
            }

            list.innerHTML = "";
            reports.forEach(report => {
                const date = new Date(report.created_at).toLocaleDateString();
                list.innerHTML += `
                    <tr>
                        <td>${date}</td>
                        <td>[${report.dept_code}]</td>
                        <td>LEVEL_${report.clearance_level}</td>
                        <td style="color:var(--primary-color)">${report.title}</td>
                        <td>${report.author_name || 'UNKNOWN'}</td>
                        <td><button onclick="viewReport('${report.id}')">OPEN_FILE</button></td>
                    </tr>
                `;
            });
        }

        function viewReport(id) {
            window.location.href = `view.html?id=${id}`;
        }

        initArchive();
    </script>
</body>
</html>