<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SCiPNET - Records Archive</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>DATABASE_QUERY: SECURE_ARCHIVES</h1>
    <nav>
        <a href="dashboard.html">RETURN_TO_DASHBOARD</a>
        <div id="overseer-filters" style="display:none; margin-top:10px; border:1px solid gold; padding:5px;">
            <span style="color:gold">OVERSEER_VIEW:</span>
            <select id="dept-filter" onchange="fetchReports()">
                <option value="ALL">ALL_DEPARTMENTS</option>
                <option value="ScD">SCIENTIFIC (ScD)</option>
                <option value="MD">MEDICAL (MD)</option>
                <option value="RAISA">INFOSEC (RAISA)</option>
                <option value="AD">ADMINISTRATIVE (AD)</option>
            </select>
        </div>
    </nav>

    <table id="archive-table">
        <thead>
            <tr>
                <th>DATE</th>
                <th>DEPT</th>
                <th>CLEARANCE</th>
                <th>DOCUMENT_TITLE</th>
                <th>AUTHOR</th>
                <th>ACTION</th>
            </tr>
        </thead>
        <tbody id="report-list">
        </tbody>
    </table>

    <script>
        let isTerminalAdmin = false;
        let isO5 = false;

        async function initArchive() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) { window.location.href = "index.html"; return; }

            const { data: profile } = await _supabase.from('profiles').select('*').eq('id', user.id).single();
            
            // Checking for both Terminal Admin and O5 status for the filter view
            if (profile.is_overseer || (profile.is_admin && profile.department === 'OVERSEER')) {
                isTerminalAdmin = true;
                document.getElementById('overseer-filters').style.display = 'block';
            } else if (profile.is_admin) {
                isO5 = true;
            }
            
            fetchReports();
        }

        async function fetchReports() {
            const list = document.getElementById('report-list');
            list.innerHTML = "<tr><td colspan='6'>RETRIEVING_DATA...</td></tr>";

            const { data: { user } } = await _supabase.auth.getUser();
            const { data: profile } = await _supabase.from('profiles').select('department, clearance_level').eq('id', user.id).single();

            // POINTED TO 'articles' table instead of 'reports'
            let query = _supabase.from('articles').select('*').order('created_at', { ascending: false });

            // APPLY FILTERS (Matched to your new RLS Logic)
            if (!isTerminalAdmin) {
                if (isO5) {
                    // O5s see their whole department
                    query = query.eq('department', profile.department);
                } else {
                    // Standard personnel see their dept + clearance check
                    query = query.eq('department', profile.department)
                                 .lte('required_clearance', profile.clearance_level);
                }
            } else {
                // Overseer/Terminal Admin filters
                const filter = document.getElementById('dept-filter').value;
                if (filter !== "ALL") {
                    query = query.eq('department', filter);
                }
            }

            const { data: reports, error } = await query;

            if (error) {
                list.innerHTML = `<tr><td colspan='6' style='color:var(--error-red)'>QUERY_ERROR: ${error.message}</td></tr>`;
                return;
            }

            list.innerHTML = "";
            if (reports.length === 0) {
                list.innerHTML = "<tr><td colspan='6'>NO_RECORDS_FOUND_UNDER_CURRENT_CLEARANCE</td></tr>";
                return;
            }

            reports.forEach(report => {
                const date = new Date(report.created_at).toLocaleDateString();
                list.innerHTML += `
                    <tr>
                        <td>${date}</td>
                        <td>[${report.department}]</td>
                        <td>LEVEL_${report.required_clearance}</td>
                        <td style="color:var(--terminal-green)">${report.title || 'UNTITLED_FILE'}</td>
                        <td>${report.author || 'UNKNOWN'}</td>
                        <td><button onclick="viewReport('${report.id}')">OPEN_FILE</button></td>
                    </tr>
                `;
            });
        }

        function viewReport(id) {
            window.location.href = `view.html?id=${id}`;
        }

        initArchive();
    </script>
</body>
</html>