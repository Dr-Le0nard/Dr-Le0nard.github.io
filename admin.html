<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SCiPNET - Admin Override</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="alert.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>ADMIN_TERMINAL_OVERRIDE</h1>
    <nav><a href="dashboard.html">BACK_TO_DASHBOARD</a></nav>
    
    <section>
        <h2>PENDING_ACCESS_REQUESTS</h2>
        <div id="pending-list">SCANNING_FOR_REQUESTS...</div>
    </section>

    <hr style="border: 1px solid var(--terminal-green); margin: 40px 0;">

    <section>
        <h2>ACTIVE_PERSONNEL_MANAGEMENT</h2>
        <div id="active-list">SCANNING_ACTIVE_USERS...</div>
    </section>

    <script>
        async function initAdmin() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) { window.location.href = "index.html"; return; }

            // Verify Admin Status
            const { data: me } = await _supabase.from('profiles').select('is_admin').eq('id', user.id).single();
            
            if (!me || !me.is_admin) {
                alert("ACCESS_DENIED: ADMINISTRATIVE_PRIVILEGES_REQUIRED");
                window.location.href = "dashboard.html";
                return;
            }

            loadPending();
            loadActiveUsers();
        }

        async function loadPending() {
            const { data: pending, error } = await _supabase
                .from('profiles')
                .select('*')
                .eq('is_approved', false);

            const container = document.getElementById('pending-list');
            if (error) { container.innerHTML = "ERROR_FETCHING_DATA"; return; }
            
            container.innerHTML = pending.length === 0 ? "NO_PENDING_REQUESTS" : "";

            pending.forEach(u => {
                container.innerHTML += `
                    <div class="scp-card">
                        <p>USER: ${u.full_name} (${u.id.substring(0,8)}...)</p>
                        <label>ASSIGN_CLEARANCE:</label>
                        <select id="lvl-${u.id}">
                            <option value="1">Level 1 (Restricted)</option>
                            <option value="2">Level 2 (Confidential)</option>
                            <option value="3">Level 3 (Secret)</option>
                            <option value="4">Level 4 (Top Secret)</option>
                            <option value="5">Level 5 (Thaumiel/O5)</option>
                        </select>
                        <button onclick="approveUser('${u.id}')">GRANT_ACCESS</button>
                    </div>`;
            });
        }

        async function loadActiveUsers() {
            const { data: active, error } = await _supabase
                .from('profiles')
                .select('*')
                .eq('is_approved', true)
                .order('full_name', { ascending: true });

            const container = document.getElementById('active-list');
            if (error) { container.innerHTML = "ERROR_FETCHING_DATA"; return; }

            container.innerHTML = active.length === 0 ? "NO_ACTIVE_USERS" : "";

            active.forEach(u => {
                // We don't want to show a revoke button for ourselves!
                const isMe = _supabase.auth.getUser().id === u.id;
                
                container.innerHTML += `
                    <div class="scp-card" style="border-style: dashed; opacity: 0.8;">
                        <p>${u.full_name} [LEVEL ${u.clearance_level}] ${u.is_admin ? '(ADMIN)' : ''}</p>
                        <button onclick="revokeAccess('${u.id}')" 
                                style="color: #ff4444; border-color: #ff4444;"
                                ${u.is_admin ? 'disabled' : ''}>
                            REVOKE_ACCESS
                        </button>
                    </div>`;
            });
        }

        async function approveUser(userId) {
            const selectedLevel = document.getElementById(`lvl-${userId}`).value;
            const { error } = await _supabase
                .from('profiles')
                .update({ is_approved: true, clearance_level: parseInt(selectedLevel) })
                .eq('id', userId);
            
            if (error) alert("UPDATE_FAILED: " + error.message);
            else location.reload();
        }

        async function revokeAccess(userId) {
            if (confirm("WARNING: PERMANENTLY BAN THIS USER?")) {
                const { error } = await _supabase
                    .from('profiles')
                    .update({ 
                        is_approved: false, 
                        is_banned: true // They are now blacklisted
                    })
                    .eq('id', userId);
                
                if (error) alert("BAN_FAILED: " + error.message);
                else location.reload();
            }
        }

        window.onload = initAdmin;
    </script>
</body>
</html>