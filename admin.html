<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SCiPNET - Admin Override</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="alert.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>ADMIN_TERMINAL_OVERRIDE</h1>
    <nav><a href="dashboard.html">BACK_TO_DASHBOARD</a></nav>
    
    <section style="margin-bottom: 30px;">
        <label>FILTER_PERSONNEL_DATABASE:</label>
        <input type="text" id="user-search" placeholder="ENTER_NAME_OR_ID..." onkeyup="filterUsers()">
    </section>

    <section>
        <h2>PENDING_ACCESS_REQUESTS</h2>
        <div id="pending-list" class="admin-grid">SCANNING_FOR_REQUESTS...</div>
    </section>

    <hr style="border: 1px solid var(--terminal-green); margin: 40px 0;">

    <section>
        <h2>ACTIVE_PERSONNEL_MANAGEMENT</h2>
        <div id="active-list" class="admin-grid">SCANNING_ACTIVE_USERS...</div>
    </section>

    <script>
        let currentUserId = null;
        let myProfile = null;

        async function initAdmin() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) { window.location.href = "index.html"; return; }
            
            currentUserId = user.id;

            const { data: me } = await _supabase.from('profiles').select('*').eq('id', user.id).single();
            
            if (!me || !me.is_admin) {
                alert("ACCESS_DENIED: ADMINISTRATIVE_PRIVILEGES_REQUIRED");
                window.location.href = "dashboard.html";
                return;
            }

            myProfile = me;
            loadPending();
            loadActiveUsers();
        }

        async function loadPending() {
            const { data: pending, error } = await _supabase
                .from('profiles')
                .select('*')
                .eq('is_approved', false)
                .eq('is_banned', false); 

            const container = document.getElementById('pending-list');
            if (error) { container.innerHTML = "ERROR_FETCHING_DATA"; return; }
            
            container.innerHTML = pending.length === 0 ? "NO_PENDING_REQUESTS" : "";

            pending.forEach(u => {
                container.innerHTML += `
                    <div class="scp-card user-item" data-name="${u.full_name.toLowerCase()}">
                        <p><strong>USER:</strong> ${u.full_name}</p>
                        <label>ASSIGN_DEPARTMENT:</label>
                        <select id="dept-${u.id}">
                            <option value="ScD">Scientific (ScD)</option>
                            <option value="MD">Medical (MD)</option>
                            <option value="SD">Security (SD)</option>
                            <option value="EcD">Engineering (EcD)</option>
                            <option value="RAISA">Infosec (RAISA)</option>
                            <option value="AD">Administrative (AD)</option>
                            <option value="ISD">Intelligence (ISD)</option>
                        </select>
                        <label>ASSIGN_CLEARANCE:</label>
                        <select id="lvl-${u.id}">
                            <option value="1">Level 1</option>
                            <option value="2">Level 2</option>
                            <option value="3">Level 3</option>
                            <option value="4">Level 4</option>
                            <option value="5">Level 5</option>
                        </select>
                        <div style="margin-top:15px;">
                            <button onclick="approveUser('${u.id}')">GRANT_ACCESS</button>
                            <button onclick="revokeAccess('${u.id}')">DENY</button>
                        </div>
                    </div>`;
            });
        }

        async function loadActiveUsers() {
            const { data: active, error } = await _supabase
                .from('profiles')
                .select('*')
                .eq('is_approved', true)
                .order('full_name', { ascending: true });

            const container = document.getElementById('active-list');
            if (error) { container.innerHTML = "ERROR_FETCHING_DATA"; return; }

            container.innerHTML = active.length === 0 ? "NO_ACTIVE_USERS" : "";

            active.forEach(u => {
                const isMe = currentUserId === u.id;
                container.innerHTML += `
                    <div class="scp-card user-item" data-name="${u.full_name.toLowerCase()}">
                        <p><strong>${u.full_name}</strong></p>
                        <p>DEPT: [${u.department || 'NONE'}] | CL: [${u.clearance_level}]</p>
                        <div style="display: flex; justify-content: center;">
                            <button onclick="revokeAccess('${u.id}')" 
                                    ${(isMe || (u.is_admin && !myProfile.is_overseer)) ? 'disabled' : ''}>
                                ${isMe ? 'YOU (ROOT)' : 'REVOKE_ACCESS'}
                            </button>
                        </div>
                    </div>`;
            });
        }

        // --- LIVE SEARCH LOGIC ---
        function filterUsers() {
            const query = document.getElementById('user-search').value.toLowerCase();
            const users = document.querySelectorAll('.user-item');

            users.forEach(user => {
                const name = user.getAttribute('data-name');
                if (name.includes(query)) {
                    user.style.display = "flex"; // Matches scp-card display
                } else {
                    user.style.display = "none";
                }
            });
        }

        async function approveUser(userId) {
            const selectedLevel = document.getElementById(`lvl-${userId}`).value;
            const selectedDept = document.getElementById(`dept-${userId}`).value;
            const { error } = await _supabase.from('profiles').update({ 
                is_approved: true, is_banned: false, clearance_level: parseInt(selectedLevel), department: selectedDept
            }).eq('id', userId);
            if (error) alert("UPDATE_FAILED: " + error.message);
            else location.reload();
        }

        async function revokeAccess(userId) {
            if (confirm("WARNING: PERMANENTLY BAN THIS USER?")) {
                const { error } = await _supabase.from('profiles').update({ 
                    is_approved: false, is_banned: true 
                }).eq('id', userId);
                if (error) alert("BAN_FAILED: " + error.message);
                else location.reload();
            }
        }

        window.onload = initAdmin;
    </script>
</body>
</html>