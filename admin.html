<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SCiPNET - Admin Override</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="alert.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>ADMIN_TERMINAL_OVERRIDE</h1>
    <nav><a href="dashboard.html">BACK_TO_DASHBOARD</a></nav>
    
    <div id="pending-list">SCANNING_FOR_REQUESTS...</div>

    <script>
        async function loadPending() {
            const { data: { user } } = await _supabase.auth.getUser();
            const { data: me } = await _supabase.from('profiles').select('is_admin').eq('id', user.id).single();
            
            if (!me || !me.is_admin) {
                window.location.href = "dashboard.html";
                return;
            }

            const { data: pending } = await _supabase
                .from('profiles')
                .select('*')
                .eq('is_approved', false);

            const container = document.getElementById('pending-list');
            container.innerHTML = pending.length === 0 ? "NO_PENDING_REQUESTS" : "";

            pending.forEach(u => {
                container.innerHTML += `
                    <div class="scp-card">
                        <p>USER: ${u.full_name} (${u.id.substring(0,8)}...)</p>
                        <label>ASSIGN_CLEARANCE:</label>
                        <select id="lvl-${u.id}">
                            <option value="1">Level 1 (Restricted)</option>
                            <option value="2">Level 2 (Confidential)</option>
                            <option value="3">Level 3 (Secret)</option>
                            <option value="4">Level 4 (Top Secret)</option>
                            <option value="5">Level 5 (Thaumiel/O5)</option>
                        </select>
                        <button onclick="approveUser('${u.id}')">GRANT_ACCESS</button>
                    </div>`;
            });
        }

        async function approveUser(userId) {
            const selectedLevel = document.getElementById(`lvl-${userId}`).value;
            
            const { error } = await _supabase
                .from('profiles')
                .update({ 
                    is_approved: true, 
                    clearance_level: parseInt(selectedLevel) 
                })
                .eq('id', userId);
            
            if (error) {
                alert("UPDATE_FAILED: " + error.message);
            } else {
                location.reload();
            }
        }

        // Enter key listener for the whole page
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                // Since there might be multiple buttons, 
                // we don't auto-submit on Admin page to prevent accidental approvals.
            }
        });

        window.onload = loadPending;
    </script>
</body>
</html>