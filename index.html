<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SCiPNET - Login</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="alert.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="login-screen">
    <div class="terminal-box">
        <h1 id="auth-title">SCiPNET_USER_LOGIN</h1>
        
        <div class="input-group">
            <label>IDENTIFIER:</label>
            <input type="email" id="email" placeholder="email@foundation.scp">
        </div>
        
        <div class="input-group">
            <label>CREDENTIALS:</label>
            <input type="password" id="password" placeholder="password">
        </div>

        <div id="reg-fields" style="display:none;">
            <div class="input-group">
                <label>FULL_NAME:</label>
                <input type="text" id="fullname" placeholder="Dr. Bright">
            </div>
        </div>

        <div class="auth-actions">
            <button id="submit-btn" onclick="handleAuth()">LOGIN</button>
            <p onclick="toggleAuth()" id="toggle-text" style="cursor:pointer; text-decoration:underline;">[REQUEST_NEW_ACCESS]</p>
        </div>
        
        <p id="error-msg" style="color:red;"></p>
    </div>

    <script>
        let isRegistering = false;

        // Toggle between Login and Register
        function toggleAuth() {
            isRegistering = !isRegistering;
            document.getElementById('auth-title').innerText = isRegistering ? "ACCESS_REQUEST_FORM" : "SCiPNET_USER_LOGIN";
            document.getElementById('submit-btn').innerText = isRegistering ? "SUBMIT_REQUEST" : "LOGIN";
            document.getElementById('reg-fields').style.display = isRegistering ? "block" : "none";
            document.getElementById('toggle-text').innerText = isRegistering ? "[BACK_TO_LOGIN]" : "[REQUEST_NEW_ACCESS]";
        }

        // Listen for Enter Key
        document.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                handleAuth();
            }
        });

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('error-msg');
            const submitBtn = document.getElementById('submit-btn');

            // Visual feedback
            submitBtn.innerText = "PROCESSING...";
            submitBtn.disabled = true;

            if (isRegistering) {
                const fullName = document.getElementById('fullname').value;
                
                // 1. Sign up the user (This sends the email automatically)
                const { data, error } = await _supabase.auth.signUp({ 
                    email, 
                    password,
                    options: {
                        // We store the name in 'metadata' so we can grab it AFTER they confirm
                        data: { full_name: fullName }
                    }
                });
                
                if (error) { 
                    errorMsg.innerText = "ERROR: " + error.message; 
                    submitBtn.innerText = "RETRY";
                    submitBtn.disabled = false;
                    return; 
                }

                // 2. Inform the user to check their email
                document.querySelector('.terminal-box').innerHTML = `
                    <h1>REQUEST_SENT</h1>
                    <p>A verification link has been dispatched to: <br><strong>${email}</strong></p>
                    <p>Verify your identity via the link, then return to this terminal to login.</p>
                    <button onclick="location.reload()">RETURN_TO_LOGIN</button>
                `;
            } else {
                // Login logic (This only works AFTER they confirm email)
                const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
                
                if (error) { 
                    errorMsg.innerText = "ACCESS_DENIED: " + error.message;
                    submitBtn.innerText = "LOGIN";
                    submitBtn.disabled = false;
                } else { 
                    // Once they login, we check if their profile exists. 
                    // If it doesn't, we create it now using the metadata we saved!
                    await checkAndCreateProfile(data.user);
                    window.location.href = "dashboard.html"; 
                }
            }
        }

        // New helper function to bridge the gap
        async function checkAndCreateProfile(user) {
            const { data: profile } = await _supabase
                .from('profiles')
                .select('id')
                .eq('id', user.id)
                .single();

            if (!profile) {
                // This is the first time they've logged in after confirming email
                await _supabase.from('profiles').insert([{ 
                    id: user.id, 
                    full_name: user.user_metadata.full_name, 
                    is_approved: false, 
                    clearance_level: 0 
                }]);
            }
        }
    </script>
</body>
</html>