<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SCiPNET - Login</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="alert.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="login-screen">
    <div class="terminal-box">
        <h1 id="auth-title">SCiPNET_USER_LOGIN</h1>
        
        <div class="input-group">
            <label>IDENTIFIER:</label>
            <input type="email" id="email" placeholder="email@foundation.scp">
        </div>
        
        <div class="input-group">
            <label>CREDENTIALS:</label>
            <input type="password" id="password" placeholder="password">
        </div>

        <div id="reg-fields" style="display:none;">
            <div class="input-group">
                <label>FULL_NAME:</label>
                <input type="text" id="fullname" placeholder="Dr. Bright">
            </div>
            <div class="input-group">
                <label>SELECT_DEPARTMENT:</label>
                <select id="dept-choice" style="width: 100%; background: black; color: var(--terminal-green); border: 1px solid var(--terminal-green); font-family: 'VT323'; padding: 5px;">
                    <option value="">-- CHOOSE_UNIT --</option>
                    <option value="ScD">Scientific (ScD)</option>
                    <option value="MD">Medical (MD)</option>
                    <option value="SD">Security (SD)</option>
                    <option value="EcD">Engineering (EcD)</option>
                    <option value="RAISA">Infosec (RAISA)</option>
                    <option value="AD">Administrative (AD)</option>
                    <option value="ISD">Intelligence (ISD)</option>
                </select>
            </div>
        </div>

        <div class="auth-actions">
            <button id="submit-btn" onclick="handleAuth()">LOGIN</button>
            <p onclick="toggleAuth()" id="toggle-text" style="cursor:pointer; text-decoration:underline;">[REQUEST_NEW_ACCESS]</p>
        </div>
        
        <p id="error-msg" style="color:red;"></p>
    </div>

    <script>
        let isRegistering = false;

        function toggleAuth() {
            isRegistering = !isRegistering;
            document.getElementById('auth-title').innerText = isRegistering ? "ACCESS_REQUEST_FORM" : "SCiPNET_USER_LOGIN";
            document.getElementById('submit-btn').innerText = isRegistering ? "SUBMIT_REQUEST" : "LOGIN";
            document.getElementById('reg-fields').style.display = isRegistering ? "block" : "none";
            document.getElementById('toggle-text').innerText = isRegistering ? "[BACK_TO_LOGIN]" : "[REQUEST_NEW_ACCESS]";
        }

        function typeWriter(text, elementId, speed = 30) {
            let i = 0;
            const element = document.getElementById(elementId);
            element.innerHTML = ""; 
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                }
            }
            type();
        }

        async function checkInitialBanStatus() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (user) {
                const { data: profile } = await _supabase
                    .from('profiles')
                    .select('is_banned')
                    .eq('id', user.id)
                    .maybeSingle();

                if (profile && profile.is_banned) {
                    showRedScreen(user.id); 
                }
            }
        }

        function showRedScreen(userId) {
            document.body.innerHTML = `
                <div class="banned-overlay" style="background: #200; color: #f00; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; font-family: monospace; border: 5px solid #f00;">
                    <div class="flicker-text" style="font-size: 3rem; font-weight: bold;">TERMINAL_LOCKED</div>
                    <div class="warning-box" style="border: 2px solid #f00; padding: 20px; margin: 20px; background: rgba(255,0,0,0.1);">
                        <h2>[ SECURITY_BREACH_DETECTED ]</h2>
                        <p id="typewriter-revocation"></p>
                        <hr style="border: 1px solid #f00;">
                        <p id="typewriter-threat" style="color: #ff5555;"></p>
                    </div>
                    <button id="ack-btn" style="background: #f00; color: #000; border: none; padding: 15px 30px; cursor: pointer; font-weight: bold; display: none;">
                        ACKNOWLEDGE_TERMINATION
                    </button>
                </div>`;
            
            typeWriter(`USER_ID: ${userId} | STATUS: PERMANENT_REVOCATION`, "typewriter-revocation", 40);
            
            setTimeout(() => {
                typeWriter("MEMETIC_KILL_AGENT_ACTIVATED... DISPATCHING INTERNAL SECURITY DEPT.", "typewriter-threat", 30);
                document.getElementById('ack-btn').style.display = "block";
            }, 2000);

            document.getElementById('ack-btn').onclick = async () => {
                await _supabase.auth.signOut();
                location.reload(); 
            };
        }

        checkInitialBanStatus();

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('error-msg');
            const submitBtn = document.getElementById('submit-btn');

            submitBtn.innerText = "PROCESSING...";
            submitBtn.disabled = true;

            if (isRegistering) {
                const fullName = document.getElementById('fullname').value;
                const deptChoice = document.getElementById('dept-choice').value;

                if (!fullName || !deptChoice) {
                    errorMsg.innerText = "ERROR: ALL_FIELDS_REQUIRED";
                    submitBtn.innerText = "RETRY";
                    submitBtn.disabled = false;
                    return;
                }

                const { data, error } = await _supabase.auth.signUp({ 
                    email, 
                    password,
                    options: { 
                        data: { 
                            full_name: fullName,
                            department: deptChoice 
                        } 
                    }
                });
                
                if (error) { 
                    errorMsg.innerText = "ERROR: " + error.message; 
                    submitBtn.innerText = "RETRY";
                    submitBtn.disabled = false;
                    return; 
                }

                document.querySelector('.terminal-box').innerHTML = `
                    <h1>REQUEST_SENT</h1>
                    <p>Verification link dispatched to: <br><strong>${email}</strong></p>
                    <p>Departmental O5 notified of pending request.</p>
                    <button onclick="location.reload()">RETURN_TO_LOGIN</button>
                `;
            } else {
                const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
                
                if (error) { 
                    errorMsg.innerText = "ACCESS_DENIED: " + error.message;
                    submitBtn.innerText = "LOGIN";
                    submitBtn.disabled = false;
                } else { 
                    const { data: profile } = await _supabase
                        .from('profiles')
                        .select('is_banned')
                        .eq('id', data.user.id)
                        .maybeSingle();

                    if (profile && profile.is_banned) {
                        showRedScreen(data.user.id);
                        return;
                    }

                    await checkAndCreateProfile(data.user);
                    window.location.href = "dashboard.html";
                }
            }
        }

        async function checkAndCreateProfile(user) {
            const { data: profile } = await _supabase
                .from('profiles')
                .select('id')
                .eq('id', user.id)
                .maybeSingle();

            if (!profile) {
                const fullName = user.user_metadata.full_name || "REDACTED_NAME";
                const department = user.user_metadata.department || null;
                
                await _supabase.from('profiles').insert([{ 
                    id: user.id, 
                    full_name: fullName,
                    department: department,
                    is_approved: false, 
                    is_banned: false,
                    clearance_level: 0 
                }]);
            }
        }
    </script>
</body>
</html>