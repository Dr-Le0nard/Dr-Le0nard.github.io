<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SCiPNET - Login</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="alert.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="login-screen">
    <div class="terminal-box">
        <h1 id="auth-title">SCiPNET_USER_LOGIN</h1>
        
        <div class="input-group">
            <label>IDENTIFIER:</label>
            <input type="email" id="email" placeholder="email@foundation.scp">
        </div>
        
        <div class="input-group">
            <label>CREDENTIALS:</label>
            <input type="password" id="password" placeholder="password">
        </div>

        <div id="reg-fields" style="display:none;">
            <div class="input-group">
                <label>FULL_NAME:</label>
                <input type="text" id="fullname" placeholder="Dr. Bright">
            </div>
        </div>

        <div class="auth-actions">
            <button id="submit-btn" onclick="handleAuth()">LOGIN</button>
            <p onclick="toggleAuth()" id="toggle-text" style="cursor:pointer; text-decoration:underline;">[REQUEST_NEW_ACCESS]</p>
        </div>
        
        <p id="error-msg" style="color:red;"></p>
    </div>

    <script>
        let isRegistering = false;

        function toggleAuth() {
            isRegistering = !isRegistering;
            document.getElementById('auth-title').innerText = isRegistering ? "ACCESS_REQUEST_FORM" : "SCiPNET_USER_LOGIN";
            document.getElementById('submit-btn').innerText = isRegistering ? "SUBMIT_REQUEST" : "LOGIN";
            document.getElementById('reg-fields').style.display = isRegistering ? "block" : "none";
            document.getElementById('toggle-text').innerText = isRegistering ? "[BACK_TO_LOGIN]" : "[REQUEST_NEW_ACCESS]";
        }

        // Typewriter Effect Function
        function typeWriter(text, elementId, speed = 30) {
            let i = 0;
            const element = document.getElementById(elementId);
            element.innerHTML = ""; // Clear existing
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                }
            }
            type();
        }

        document.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleAuth();
            }
        });

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('error-msg');
            const submitBtn = document.getElementById('submit-btn');

            submitBtn.innerText = "PROCESSING...";
            submitBtn.disabled = true;

            if (isRegistering) {
                const fullName = document.getElementById('fullname').value;
                const { data, error } = await _supabase.auth.signUp({ 
                    email, 
                    password,
                    options: { data: { full_name: fullName } }
                });
                
                if (error) { 
                    errorMsg.innerText = "ERROR: " + error.message; 
                    submitBtn.innerText = "RETRY";
                    submitBtn.disabled = false;
                    return; 
                }

                document.querySelector('.terminal-box').innerHTML = `
                    <h1>REQUEST_SENT</h1>
                    <p>Verification link dispatched to: <br><strong>${email}</strong></p>
                    <p>Verify via email, then return to login.</p>
                    <button onclick="location.reload()">RETURN_TO_LOGIN</button>
                `;
            } else {
                // --- LOGIN LOGIC ---
                const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
                
                if (error) { 
                    errorMsg.innerText = "ACCESS_DENIED: " + error.message;
                    submitBtn.innerText = "LOGIN";
                    submitBtn.disabled = false;
                } else { 
                    // 1. Check if the user is BANNED
                    const { data: profile } = await _supabase
                        .from('profiles')
                        .select('is_banned')
                        .eq('id', data.user.id)
                        .maybeSingle();

                    if (profile && profile.is_banned) {
                        // Display the Banned Screen Structure
                        document.body.innerHTML = `
                            <div class="banned-overlay">
                                <div class="scanlines"></div>
                                <div class="flicker-text">TERMINAL_LOCKED</div>
                                
                                <div class="warning-box">
                                    <h2 style="margin-top: 0;">[ SECURITY_BREACH_DETECTED ]</h2>
                                    <p id="typewriter-revocation"></p>
                                    <hr style="border: 1px solid #ff0000;">
                                    <p id="typewriter-threat" style="font-size: 0.9rem; color: #ff5555;"></p>
                                </div>

                                <button onclick="location.reload()" style="margin-top: 40px; background: #ff0000; color: black; border: none; padding: 10px 20px; font-family: monospace; cursor: pointer; font-weight: bold;">
                                    ACKNOWLEDGE_TERMINATION
                                </button>
                            </div>`;
                        
                        // Run typewriter effects
                        typeWriter(`USER_ID: ${data.user.id} | STATUS: PERMANENT_REVOCATION_BY_O5_COUNCIL`, "typewriter-revocation", 40);
                        setTimeout(() => {
                            typeWriter("MEMETIC_KILL_AGENT_ACTIVATED... STAY AT YOUR TERMINAL. DISPATCHING INTERNAL SECURITY DEPT.", "typewriter-threat", 30);
                        }, 2500);

                        await _supabase.auth.signOut();
                        return;
                    }

                    // 2. Not banned? Check/Create profile and go to Dashboard
                    await checkAndCreateProfile(data.user);
                    window.location.href = "dashboard.html";
                }
            }
        }

        async function checkAndCreateProfile(user) {
            const { data: profile } = await _supabase
                .from('profiles')
                .select('id')
                .eq('id', user.id)
                .maybeSingle();

            if (!profile) {
                const fullName = user.user_metadata.full_name || "REDACTED_NAME";
                await _supabase.from('profiles').insert([{ 
                    id: user.id, 
                    full_name: fullName, 
                    is_approved: false, 
                    is_banned: false,
                    clearance_level: 0 
                }]);
            }
        }
    </script>
</body>
</html>