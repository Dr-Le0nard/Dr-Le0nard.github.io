<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SCiPNET - Departmental Entry</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="alert.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1 id="form-header">INITIALIZING_REPORT_MODULE...</h1>
    <nav>
        <a href="dashboard.html">BACK_TO_DASHBOARD</a>
    </nav>

    <div class="input-container">
        <div id="dynamic-fields" style="border-left: 2px solid var(--primary-color); padding-left: 15px; margin-bottom: 20px;">
            </div>

        <label>DOCUMENT_TITLE:</label>
        <input type="text" id="title" placeholder="ENTER_LOG_TITLE">

        <label>CLEARANCE_RESTRICTION:</label>
        <select id="clearance_level">
            <option value="0">LEVEL_0 (PUBLIC)</option>
            <option value="1">LEVEL_1 (RESTRICTED)</option>
            <option value="2">LEVEL_2 (CONFIDENTIAL)</option>
            <option value="3">LEVEL_3 (SECRET)</option>
            <option value="4">LEVEL_4 (TOP_SECRET)</option>
            <option value="5">LEVEL_5 (O5_ONLY)</option>
        </select>

        <label>DOCUMENT_CONTENT:</label>
        <textarea id="content" rows="15" placeholder="START DATA ENTRY..."></textarea>

        <button onclick="submitReport()">TRANSMIT_TO_SECURE_SERVERS</button>
    </div>

    <script>
        let currentUserProfile = null;
        const urlParams = new URLSearchParams(window.location.search);
        const reportModule = urlParams.get('type') || 'general';

        async function initializeForm() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) { window.location.href = "index.html"; return; }

            const { data: profile } = await _supabase
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .single();
            
            currentUserProfile = profile;
            document.getElementById('form-header').innerText = `NEW_${reportModule.toUpperCase()}_ENTRY`;
            setupExtraFields();
        }

        function setupExtraFields() {
            const container = document.getElementById('dynamic-fields');
            if (reportModule === 'research') {
                container.innerHTML = `
                    <label>SUBJECT_ID:</label>
                    <input type="text" id="meta_subject" placeholder="e.g. SCP-096">
                    <label>TEST_PHASE:</label>
                    <input type="text" id="meta_phase" placeholder="e.g. Initial Exposure">
                `;
            } else if (reportModule === 'medical') {
                container.innerHTML = `
                    <label>PATIENT_ID:</label>
                    <input type="text" id="meta_patient" placeholder="e.g. D-9022">
                `;
            }
        }

        async function submitReport() {
            const titleInput = document.getElementById('title').value;
            const contentInput = document.getElementById('content').value;
            const cl = document.getElementById('clearance_level').value;

            if(!titleInput || !contentInput) {
                alert("CRITICAL_ERROR: DATA_MISSING");
                return;
            }

            // Consolidate extra fields into the top of the content for readability
            let finalizedContent = "";
            const extraInputs = document.querySelectorAll('#dynamic-fields input');
            extraInputs.forEach(input => {
                const label = input.previousElementSibling.innerText;
                finalizedContent += `${label} ${input.value}\n`;
            });
            finalizedContent += "\n" + contentInput;

            // POINTED TO 'articles' table with correct column names
            const { error } = await _supabase
                .from('articles') 
                .insert([{ 
                    title: titleInput, 
                    content: finalizedContent, 
                    author: currentUserProfile.full_name,
                    department: currentUserProfile.department, 
                    required_clearance: parseInt(cl)
                }]);

            if (error) {
                alert("TRANSMISSION_FAILED: " + error.message);
            } else {
                alert("TRANSMISSION_SUCCESSFUL");
                window.location.href = "archive.html"; // Send them to the archive to see their work
            }
        }

        initializeForm();
    </script>
</body>
</html>